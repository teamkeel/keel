package foo

import (
	"fmt"

	"github.com/graphql-go/graphql"
	"github.com/samber/lo"
	"github.com/teamkeel/keel/proto"
)

func MakeGQLSchema(keelSchema *proto.Schema) (gqlSchema *graphql.Schema) {
	// todo set the Query field in the returned object
	return gqlSchema
}

func composeTopLevelQuery(schema *proto.Schema) *graphql.Object {
	topLevelQueryFields := graphql.Fields{} // map[string]*graphql.Field
	for _, model := range schema.Models {
		fieldsInTheModel := composeFields(model, schema) // map[string]*graphql.Field
		gqlModel := graphql.NewObject(graphql.ObjectConfig{
			Name:   model.Name,
			Fields: fieldsInTheModel,
		})
		modelAsField := graphql.Field{
			Name: model.Name,
			Type: ModelAsOutput{
				referencedModel: model,
			},
		}
		topLevelQueryFields[model.Name] = &modelAsField
	}

	gqlModels := graphql.NewObject(
		graphql.ObjectConfig{
			Name:   "Query",
			Fields: topLevelQueryFields,
		},
	)

	return gqlModels
}

func composeFields(model *proto.Model, schema *proto.Schema) graphql.Fields {
	fields := graphql.Fields{}
	for _, field := range model.Fields {
		fields[field.Name] = &graphql.Field{
			Type: fieldTypeMap[field.Type],
		}
	}
	return fields
}

func composeAPI(api *proto.Api, schema *proto.Schema) {
	namesOfModelsUsedByAPI := lo.Map(api.ApiModels, func(m *proto.ApiModel, _ int) string {
		return m.ModelName
	})
	modelInstances := proto.FindModels(schema.Models, namesOfModelsUsedByAPI)

	for _, model := range modelInstances {
		composeOperations(model, schema)
	}
}

func composeOperations(model *proto.Model, schema *proto.Schema) {
	for _, op := range model.Operations {
		switch {
		case op.Type == proto.OperationType_OPERATION_TYPE_CREATE &&
			op.Implementation == proto.OperationImplementation_OPERATION_IMPLEMENTATION_AUTO:
			composeCreateAutoOp(op, model, schema)

		default:
			panic(fmt.Sprintf("This operation type not yet implemented: %v", op.Type))
		}
	}
}

func composeCreateAutoOp(op *proto.Operation, model *proto.Model, schema *proto.Schema) {
	// create createAuthor(name)
}

var fieldTypeMap map[proto.FieldType]graphql.Output = map[proto.FieldType]graphql.Output{
	proto.FieldType_FIELD_TYPE_STRING: graphql.String,
	// todo the other types
}

type ModelAsOutput struct {
	referencedModel *proto.Model
}

func (mao ModelAsOutput) Description() string {
	return "todo this is model description"
}
